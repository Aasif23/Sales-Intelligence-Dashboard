<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Intelligence Dashboard</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for creating interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts - Inter for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 for a light background */
        }
        /* Responsive chart container to maintain aspect ratio and control height */
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px; /* Default height for charts */
            max-height: 40vh; /* Max height relative to viewport height */
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px; /* Slightly shorter charts on smaller screens */
            }
        }
        /* Custom scrollbar for tables on smaller screens to improve UX */
        .table-container::-webkit-scrollbar {
            height: 8px; /* Height for horizontal scrollbar */
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* Light track background */
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Scrollbar thumb color */
            border-radius: 4px; /* Rounded corners for the thumb */
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Darker thumb on hover */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- 
        Dashboard Design Principles:
        - Palette: Utilizes a warm neutral palette (gray-50 for background, gray-800 for text, white for containers) with subtle blue accents (blue-600) for visual appeal and clarity.
        - Structure: A single-page application with a clear hierarchy. Top-level KPIs provide an immediate overview, followed by a responsive grid for detailed analytics sections. This promotes a logical flow from general insights to specific data.
        - Content & Visualization Choices:
            - Monthly Sales: A line chart is chosen for its effectiveness in displaying trends over time. Includes a country filter for segmented analysis.
            - Top 10 Customers: A horizontal bar chart allows for easy comparison and ranking of customer profitability.
            - Profitable Categories: A vertical bar chart is used to compare the total profit across different product lines.
            - Average Discount by Category: Another vertical bar chart, similar to profitable categories, for direct comparison of discount rates.
            - High-Value Orders Table: Styled HTML tables present granular, non-aggregated data, suitable for detailed review of individual transactions.
        - Libraries: All interactive charts are implemented using Chart.js, leveraging its canvas-based rendering capabilities.
    -->

    <div class="container mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Sales Intelligence Dashboard</h1>
            <p class="mt-1 text-gray-600">Analyzing trends across categories, customers, and geographies.</p>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- KPI Cards Section -->
            <section id="kpi-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 rounded-lg">
                <!-- KPI Cards will be dynamically rendered here by JavaScript -->
            </section>
            
            <!-- Monthly Sales Trend Section -->
            <section class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700">Monthly Sales Trend</h2>
                        <p class="text-sm text-gray-500 mt-1">Total sales per month. Use the dropdown to filter by country.</p>
                    </div>
                    <div class="mt-4 sm:mt-0">
                        <select id="country-filter" class="w-full sm:w-auto bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <!-- Country options will be dynamically loaded here by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </section>

            <!-- Profitability & Discount Analysis Grid -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                
                <!-- Top Customers by Profit Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">Top 10 Customers by Profit</h2>
                    <p class="text-sm text-gray-500 mt-1 mb-4">The most profitable customers based on total profit generated.</p>
                    <div class="chart-container">
                        <canvas id="topCustomersChart"></canvas>
                    </div>
                </div>

                <!-- Profitable Categories Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">Total Profit by Product Line</h2>
                    <p class="text-sm text-gray-500 mt-1 mb-4">Comparing total profit across different product categories.</p>
                    <div class="chart-container">
                        <canvas id="profitableCategoriesChart"></canvas>
                    </div>
                </div>

                <!-- Average Discount by Category Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">Average Discount by Product Line</h2>
                    <p class="text-sm text-gray-500 mt-1 mb-4">Highlights which product lines receive the highest average discounts.</p>
                     <div class="chart-container">
                        <canvas id="avgDiscountChart"></canvas>
                    </div>
                </div>
                
                <!-- High-Value Orders Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">High-Value Orders</h2>
                    <p class="text-sm text-gray-500 mt-1 mb-4">A list of individual orders with sales exceeding $5,000.</p>
                    <div class="table-container overflow-x-auto h-[350px]">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Order #</th>
                                    <th scope="col" class="px-6 py-3">Customer</th>
                                    <th scope="col" class="px-6 py-3">Sales</th>
                                </tr>
                            </thead>
                            <tbody id="high-value-orders-table">
                                <!-- Table rows will be dynamically rendered here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_BASE_URL = 'http://127.0.0.1:5000/api'; // Base URL for the Flask API

            // Chart instances to manage destruction and re-creation
            let monthlySalesChartInstance = null;
            let topCustomersChartInstance = null; 
            let profitableCategoriesChartInstance = null; 
            let avgDiscountChartInstance = null; 

            // Define consistent chart colors
            const CHART_COLORS = {
                primary: 'rgb(59, 130, 246)', /* Tailwind blue-500 */
                primaryTransparent: 'rgba(59, 130, 246, 0.2)',
                secondary: 'rgb(107, 114, 128)', /* Tailwind gray-600 */
            };

            // Base options for Chart.js charts for consistent styling and behavior
            const chartOptionsBase = {
                maintainAspectRatio: false, // Allows chart to fit parent container
                responsive: true, // Makes chart responsive to container size changes
                plugins: {
                    legend: {
                        position: 'top', // Legend at the top of the chart
                        labels: {
                            font: {
                                family: 'Inter', // Apply Inter font to legend labels
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937', // Dark gray tooltip background
                        titleFont: { size: 14, family: 'Inter' }, // Font for tooltip title
                        bodyFont: { size: 12, family: 'Inter' }, // Font for tooltip body
                        padding: 10,
                        cornerRadius: 4,
                        displayColors: false // Do not display color boxes in tooltips
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            font: { family: 'Inter' },
                            color: '#4b5563' /* Tailwind gray-600 */
                        },
                        grid: { display: false } // Hide x-axis grid lines
                    },
                    y: {
                        ticks: {
                            font: { family: 'Inter' },
                            color: '#4b5563' /* Tailwind gray-600 */
                        },
                        grid: {
                            color: '#e5e7eb' /* Tailwind gray-200 */
                        }
                    }
                }
            };

            // --- FETCH DATA FUNCTIONS ---
            /**
             * Fetches JSON data from a given URL.
             * @param {string} url - The URL to fetch data from.
             * @returns {Promise<Object|null>} The JSON data, or null if an error occurs.
             */
            async function fetchJson(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        // Log HTTP error details
                        console.error(`HTTP error! status: ${response.status} for URL: ${url}`);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Error fetching data from ${url}:`, error);
                    return null; // Return null to allow rendering functions to handle missing data gracefully
                }
            }

            /**
             * Loads all necessary dashboard data concurrently.
             * @returns {Promise<Object>} An object containing all fetched data.
             */
            async function loadAllDashboardData() {
                const [
                    kpiData,
                    monthlySalesData, // Granular data, used to populate country dropdown
                    topCustomersData,
                    categoryDiscountsData,
                    profitableCategoriesData,
                    highValueOrdersData
                ] = await Promise.all([
                    fetchJson(`${API_BASE_URL}/kpis`),
                    fetchJson(`${API_BASE_URL}/monthly_sales`), // Fetches granular monthly sales data for country dropdown
                    fetchJson(`${API_BASE_URL}/top_customers`),
                    fetchJson(`${API_BASE_URL}/category_discounts`),
                    fetchJson(`${API_BASE_URL}/profitable_categories`),
                    fetchJson(`${API_BASE_URL}/high_value_orders`)
                ]);

                // Specifically fetch aggregated "All Countries" data for the initial monthly sales chart display
                const initialMonthlySalesChartData = await fetchJson(`${API_BASE_URL}/monthly_sales?country=All Countries`);

                // Log fetched data for debugging
                console.log("Fetched KPI Data:", kpiData);
                console.log("Fetched Monthly Sales Data (for filter dropdown):", monthlySalesData); 
                console.log("Initial Monthly Sales Chart Data (All Countries aggregated):", initialMonthlySalesChartData);
                console.log("Fetched Top Customers Data:", topCustomersData);
                console.log("Fetched Category Discounts Data:", categoryDiscountsData);
                console.log("Fetched Profitable Categories Data:", profitableCategoriesData);
                console.log("Fetched High Value Orders Data:", highValueOrdersData);

                return {
                    kpiData,
                    monthlySalesDataForFilter: monthlySalesData, // Granular data for populating country dropdown
                    initialMonthlySalesChartData: initialMonthlySalesChartData, // Aggregated data for initial chart view
                    topCustomersData,
                    categoryDiscountsData,
                    profitableCategoriesData,
                    highValueOrdersData
                };
            }

            // --- RENDER FUNCTIONS ---
            
            /**
             * Renders the Key Performance Indicator (KPI) cards.
             * @param {Object} kpisData - The data for KPIs.
             */
            function renderKpiCards(kpisData) {
                const container = document.getElementById('kpi-cards');
                if (!kpisData) {
                    container.innerHTML = '<p class="col-span-full text-center text-red-500 py-4">Error loading KPIs. Please check API.</p>';
                    return;
                }
                const kpis = [
                    { label: 'Total Sales', value: kpisData.totalSales, icon: 'ðŸ’°' },
                    { label: 'Total Profit', value: kpisData.totalProfit, icon: 'ðŸ“ˆ' },
                    { label: 'Avg. Discount', value: kpisData.avgDiscount, icon: 'ðŸ·ï¸' },
                    { label: 'Total Orders', value: kpisData.totalOrders, icon: 'ðŸ“¦' }
                ];
                container.innerHTML = kpis.map(kpi => `
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="text-3xl mr-4">${kpi.icon}</div>
                        <div>
                            <p class="text-sm text-gray-500">${kpi.label}</p>
                            <p class="text-2xl font-bold text-gray-900">${kpi.value}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            /**
             * Sets up the country filter dropdown and attaches its change listener.
             * Also renders the initial monthly sales chart with "All Countries" data.
             * @param {Array<Object>} monthlySalesDataForFilter - Granular monthly sales data to extract unique countries.
             * @param {Array<Object>} initialMonthlySalesChartData - Aggregated "All Countries" data for the initial chart.
             */
            function setupFilters(monthlySalesDataForFilter, initialMonthlySalesChartData) {
                if (!monthlySalesDataForFilter) return;

                // Extract unique countries, add "All Countries" option, and sort alphabetically
                const countries = ['All Countries', ...new Set(monthlySalesDataForFilter.map(d => d.Country))].sort();
                const filterEl = document.getElementById('country-filter');
                filterEl.innerHTML = countries.map(c => `<option value="${c}">${c}</option>`).join('');
                
                // Render the monthly sales chart initially using the aggregated data for "All Countries"
                renderMonthlySalesChart(initialMonthlySalesChartData, 'All Countries');

                // Add event listener for country filter changes
                filterEl.addEventListener('change', async (e) => {
                    const selectedCountry = e.target.value;
                    let filteredMonthlySales;
                    if (selectedCountry === 'All Countries') {
                        // Re-fetch aggregated data for all countries
                        filteredMonthlySales = await fetchJson(`${API_BASE_URL}/monthly_sales?country=All Countries`);
                    } else {
                        // Fetch data for the specific selected country
                        filteredMonthlySales = await fetchJson(`${API_BASE_URL}/monthly_sales?country=${encodeURIComponent(selectedCountry)}`);
                    }
                    // Re-render the chart with the newly fetched data
                    renderMonthlySalesChart(filteredMonthlySales, selectedCountry);
                });
            }

            /**
             * Renders or updates the Monthly Sales Trend chart.
             * @param {Array<Object>} data - The monthly sales data.
             * @param {string} selectedCountryLabel - The label for the selected country (e.g., "USA", "All Countries").
             */
            function renderMonthlySalesChart(data, selectedCountryLabel = 'All Countries') {
                const chartContainer = document.getElementById('monthlySalesChart').parentElement;
                if (!data) {
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error loading monthly sales data.</p>';
                    return;
                }
                const ctx = document.getElementById('monthlySalesChart').getContext('2d');
                if (monthlySalesChartInstance) {
                    monthlySalesChartInstance.destroy(); // Destroy previous chart instance before creating a new one
                }

                // Prepare labels (e.g., "2021-01") and data points, ensuring consistent ordering
                const labels = data.map(item => `${item.SalesYear}-${String(item.SalesMonth).padStart(2, '0')}`).sort();
                const chartData = labels.map(label => {
                    const item = data.find(d => `${d.SalesYear}-${String(d.SalesMonth).padStart(2, '0')}` === label);
                    return item ? item.TotalSales : 0; // Use 0 if data point is missing for a month
                });
                
                monthlySalesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Total Sales in ${selectedCountryLabel}`,
                            data: chartData,
                            borderColor: CHART_COLORS.primary,
                            backgroundColor: CHART_COLORS.primaryTransparent,
                            fill: true, // Fill area under the line
                            tension: 0.3 // Smooth the line
                        }]
                    },
                    options: chartOptionsBase // Apply base options
                });
            }

            /**
             * Renders or updates the Top Customers by Profit chart.
             * @param {Array<Object>} data - The top customers data.
             */
            function renderTopCustomersChart(data) {
                console.log("Data for Top Customers Chart:", data); 
                const chartContainer = document.getElementById('topCustomersChart').parentElement;
                if (!data || !Array.isArray(data) || data.length === 0) { 
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">No data available for Top Customers.</p>';
                    return;
                }
                
                const ctx = document.getElementById('topCustomersChart').getContext('2d');
                if (topCustomersChartInstance) { 
                    topCustomersChartInstance.destroy(); // Destroy previous instance
                }
                try {
                    topCustomersChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(c => {
                                const name = c.CustomerName;
                                // Truncate long names for better display on the chart axis
                                return name.length > 20 ? name.substring(0, 20) + '...' : name;
                            }),
                            datasets: [{
                                label: 'Total Profit',
                                data: data.map(c => parseFloat(c.TotalProfit)), // Ensure data is parsed as float
                                backgroundColor: CHART_COLORS.primaryTransparent,
                                borderColor: CHART_COLORS.primary,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            ...chartOptionsBase, // Inherit base options
                            indexAxis: 'y', // Set to 'y' for horizontal bars
                            scales: { 
                                x: { // X-axis (value axis for horizontal bar chart)
                                    ticks: {
                                        font: { family: 'Inter' },
                                        color: '#4b5563'
                                    },
                                    grid: {
                                        color: '#e5e7eb' 
                                    }
                                },
                                y: { // Y-axis (category axis for horizontal bar chart)
                                    ticks: {
                                        font: { family: 'Inter' },
                                        color: '#4b5563'
                                    },
                                    grid: {
                                        display: false 
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error rendering Top Customers Chart:", error);
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error rendering Top Customers Chart.</p>';
                }
            }
            
            /**
             * Renders or updates the Profitable Categories chart.
             * @param {Array<Object>} data - The profitable categories data.
             */
            function renderProfitableCategoriesChart(data) {
                console.log("Data for Profitable Categories Chart:", data); 
                const chartContainer = document.getElementById('profitableCategoriesChart').parentElement;
                if (!data || !Array.isArray(data) || data.length === 0) { 
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">No data available for Profitable Categories.</p>';
                    return;
                }
                const ctx = document.getElementById('profitableCategoriesChart').getContext('2d');
                if (profitableCategoriesChartInstance) { 
                    profitableCategoriesChartInstance.destroy(); // Destroy previous instance
                }
                try {
                    profitableCategoriesChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(p => p.ProductLine),
                            datasets: [{
                                label: 'Total Profit',
                                data: data.map(p => parseFloat(p.TotalProfit)), // Ensure data is parsed as float
                                backgroundColor: CHART_COLORS.primaryTransparent,
                                borderColor: CHART_COLORS.primary,
                                borderWidth: 1
                            }]
                        },
                        options: chartOptionsBase // Apply base options
                    });
                } catch (error) {
                    console.error("Error rendering Profitable Categories Chart:", error);
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error rendering Profitable Categories Chart.</p>';
                }
            }
            
            /**
             * Renders or updates the Average Discount by Product Line chart.
             * @param {Array<Object>} data - The average discount data by category.
             */
            function renderAvgDiscountChart(data) {
                console.log("Data for Average Discount Chart:", data); 
                const chartContainer = document.getElementById('avgDiscountChart').parentElement;
                if (!data || !Array.isArray(data) || data.length === 0) { 
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">No data available for Average Discount.</p>';
                    return;
                }
                const ctx = document.getElementById('avgDiscountChart').getContext('2d');
                if (avgDiscountChartInstance) { 
                    avgDiscountChartInstance.destroy(); // Destroy previous instance
                }
                try {
                    avgDiscountChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.ProductLine),
                            datasets: [{
                                label: 'Average Discount (%)',
                                data: data.map(d => parseFloat(d.AverageDiscount * 100).toFixed(2)), // Convert to percentage and fix to 2 decimal places
                                backgroundColor: CHART_COLORS.secondary, // Use secondary color for this chart
                            }]
                        },
                        options: {
                            ...chartOptionsBase, // Inherit base options
                            plugins: {
                                ...chartOptionsBase.plugins,
                                tooltip: {
                                    ...chartOptionsBase.plugins.tooltip,
                                    callbacks: {
                                        // Custom tooltip label to display percentage sign
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error rendering Average Discount Chart:", error);
                    chartContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error rendering Average Discount Chart.</p>';
                }
            }
            
            /**
             * Renders the High-Value Orders table.
             * @param {Array<Object>} data - The high-value orders data.
             */
            function renderHighValueOrdersTable(data) {
                const tbody = document.getElementById('high-value-orders-table');
                if (!data || !Array.isArray(data) || data.length === 0) { 
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-red-500 py-4">No high-value orders data available.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(order => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${order.OrderNumber}</th>
                        <td class="px-6 py-4">${order.CustomerName}</td>
                        <td class="px-6 py-4 font-medium">$${Number(order.Sales).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `).join('');
            }
            
            // --- INITIALIZATION ---
            // This block runs when the DOM is fully loaded and initializes the dashboard.
            try {
                // Load all data required for the dashboard
                const { 
                    kpiData,
                    monthlySalesDataForFilter, 
                    initialMonthlySalesChartData,
                    topCustomersData,
                    categoryDiscountsData,
                    profitableCategoriesData,
                    highValueOrdersData
                } = await loadAllDashboardData();

                // Render each section of the dashboard
                renderKpiCards(kpiData);
                // setupFilters also handles the initial rendering of the monthly sales chart
                setupFilters(monthlySalesDataForFilter, initialMonthlySalesChartData); 
                renderTopCustomersChart(topCustomersData);
                renderProfitableCategoriesChart(profitableCategoriesData);
                renderAvgDiscountChart(categoryDiscountsData);
                renderHighValueOrdersTable(highValueOrdersData);

            } catch (error) {
                console.error("Critical error loading dashboard data:", error);
                // Display a prominent error message if initial data loading fails
                document.getElementById('kpi-cards').innerHTML = '<p class="col-span-full text-center text-red-500 text-lg">Failed to load dashboard data. Please ensure the API is running and accessible.</p>';
            }
        });
    </script>
</body>
</html>
